

##fcm co fcm:gcom.x/trunk@head gcom
##fcm co fcm:gcom.x/trunk@357 gcom
fcm co fcm:gcom.x/branches/dev/andrewpauling/vn6.2_apptainer_port gcom
cd gcom
gcom_src=$(pwd)

target="gcom6.2"

# buid and test
rose stem --group=test --name=$target --new --no-gcontrol -- --no-detach
if [ $? -ne 0 ]; then
  echo "Problem running GCOM rose stem suite."
  echo "Check suite logs and output at $HOME/cylc-run/$target"
  echo "or try http://localhost/cylc-review/taskjobs/$USER?&suite=$target."
  exit 1
fi

# copy dirs to right place (remember may have to overwrite...)
cdir="$HOME/cylc-run/$target/share"

cd $cdir
mpichdir="apptainer_linux_ifort_impi"
serialdir="apptainer_linux_ifort_serial"
serial32dir="apptainer32B_linux_ifort_serial"
if [ -d "$mpichdir" ] || [ -d "$serialdir" ] || [ -d "$serial32dir" ]; then
  echo "Found one or more GCOM build directories to install"
else
  echo "Cannot find a GCOM build in $cdir"
  exit 1
fi

install_dir="$UMDIR/gcom/6.2"
if [ -d "$install_dir" ]; then
  rm -rf $install_dir
else
  mkdir -p $install_dir
fi

cp -r $mpichdir $install_dir/. || echo "Failed to install parallel GCOM library"
cp -r $serialdir $install_dir/. || echo "Failed to install serial GCOM library"
cp -r $serial32dir $install_dir/. || echo "Failed to install 32-bit serial GCOM library"

echo "GCOM library has been installed under $install_dir"
